<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="author" content="Salah Al-Wafi">
    <meta name="developer" content="S.W Creative">
    <title>Pro AI - Salah Al-Wafi Edition</title>
    
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" media="print" onload="this.media='all'">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <style>
        :root { --primary: #7c3aed; --bg: #030712; }
        body { margin: 0; font-family: 'Cairo', sans-serif; background: var(--bg); color: white; display: flex; height: 100dvh; overflow: hidden; position: fixed; width: 100%; }
        .sidebar { width: 280px; background: #0f172a; border-left: 1px solid #1f2937; transition: transform 0.3s ease; z-index: 60; flex-shrink: 0; will-change: transform; }
        .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 55; backdrop-filter: blur(2px); }
        .sidebar-overlay.active { display: block; }
        @media (max-width: 1024px) { .sidebar { position: fixed; top: 0; right: -280px; height: 100%; transform: translateX(0); } .sidebar.open { transform: translateX(-280px); } }
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; height: 100%; }
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; display: flex; flex-direction: column; gap: 20px; contain: content; padding-bottom: 40px; }
        .message-user { align-self: flex-end; background: #1e293b; border-radius: 18px 18px 0 18px; max-width: 85%; padding: 12px 16px; border: 1px solid #334155; position: relative; }
        .message-ai { align-self: flex-start; background: rgba(124,58,237,0.05); border: 1px solid rgba(124,58,237,0.2); border-radius: 18px 18px 18px 0; max-width: 85%; padding: 12px 16px; line-height: 1.8; color: #e2e8f0; position: relative; }
        .msg-controls { display: flex; gap: 12px; margin-top: 8px; padding-top: 4px; }
        .msg-btn { font-size: 14px; cursor: pointer; color: #7c3aed; opacity: 0.6; transition: all 0.2s; display: flex; align-items: center; gap: 4px; background: rgba(124,58,237,0.1); padding: 2px 8px; border-radius: 6px; }
        .msg-btn:hover { opacity: 1; background: rgba(124,58,237,0.2); }
        .msg-btn.copied { color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .input-wrapper { background: #0f172a; border-top: 1px solid #1e293b; padding: 15px; position: sticky; bottom: 0; width: 100%; z-index: 50; }
        textarea { resize: none; max-height: 150px; width: 100%; background: transparent; color: #e2e8f0; border: none; outline: none; font-family: 'Cairo'; }
        .typing-dot { width: 6px; height: 6px; background: var(--primary); border-radius: 50%; display: inline-block; margin: 0 2px; animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .signature { font-size: 10px; color: #4b5563; text-align: center; padding: 10px; letter-spacing: 1px; }
        .mic-active { color: #ef4444 !important; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .action-btn { background: rgba(31, 41, 55, 0.8); border: 1px solid #374151; color: #9ca3af; padding: 6px 12px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .action-btn:hover { background: #374151; color: white; }
        #preview-container { display: none; margin-bottom: 10px; position: relative; width: fit-content; }
        #image-preview { max-height: 100px; border-radius: 8px; border: 1px solid #374151; }
        .remove-preview { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; items-center; justify-center; font-size: 12px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <aside id="sidebar" class="sidebar flex flex-col">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center">
            <button onclick="newChat()" class="flex-1 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 p-3 rounded-xl font-bold shadow-lg transition-transform active:scale-95">+ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button onclick="toggleSidebar()" class="lg:hidden mr-2 text-gray-400 text-2xl">Ã—</button>
        </div>
        <div id="historyList" class="p-4 flex-1 overflow-y-auto text-gray-400 text-sm space-y-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</div>
        <div class="p-4 border-t border-gray-800 space-y-3">
            <div class="signature">DESIGNED BY ENG.SALAH AL-WAFI â—ˆ 2025</div>
        </div>
    </aside>

    <main class="main-content">
        <header class="h-16 flex items-center justify-between px-6 bg-gray-900/50 border-b border-gray-800 backdrop-blur-md shrink-0">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="lg:hidden text-2xl text-purple-400">â˜°</button>
                <h1 class="text-xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">Pro AI</h1>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="downloadPDF()" class="action-btn"><span>ğŸ“„</span> <span class="hidden sm:inline">ØªØ­Ù…ÙŠÙ„ PDF</span></button>
                <button onclick="clearCurrentChat()" class="action-btn text-red-400"><span>ğŸ—‘ï¸</span> <span class="hidden sm:inline">Ù…Ø³Ø­</span></button>
            </div>
        </header>

        <div id="chat-window" class="chat-container">
            <div id="welcome" class="m-auto text-center opacity-40">
                <div class="text-6xl mb-4">âœ¨</div>
                <h2 class="text-2xl font-bold">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Pro AI</h2>
                <p class="text-sm mt-2">Ø¨ÙˆØ§Ø³Ø·Ø© ØµÙ„Ø§Ø­ Ø§Ù„ÙˆØ§ÙÙŠ</p>
            </div>
        </div>

        <div class="input-wrapper">
            <div class="max-w-4xl mx-auto">
                <div id="preview-container">
                    <img id="image-preview" src="" alt="Preview">
                    <div class="remove-preview" onclick="clearPreview()">Ã—</div>
                </div>
                <div class="flex items-end gap-2 bg-gray-900 p-2 rounded-2xl border border-gray-800 shadow-2xl">
                    <button onclick="document.getElementById('fileInput').click()" class="p-3 text-gray-400 hover:text-purple-400" title="Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù Ø£Ùˆ ØµÙˆØ±Ø©">ğŸ“</button>
                    <textarea id="userInput" rows="1" placeholder="Ø§Ø³Ø£Ù„Ù†ÙŠ Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                    <button id="voiceBtn" class="p-3 text-gray-400 hover:text-purple-400 transition-all" title="Ø¥Ø¯Ø®Ø§Ù„ ØµÙˆØªÙŠ">ğŸ¤</button>
                    <button id="sendBtn" onclick="sendMessage()" class="bg-purple-600 hover:bg-purple-500 p-3 rounded-xl transition-all active:scale-90">â¤</button>
                    <input type="file" id="fileInput" accept="image/*,application/pdf" class="hidden" onchange="handleFileUpload(this)">
                </div>
            </div>
        </div>
    </main>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            if (typeof marked !== 'undefined') {
                marked.setOptions({ highlight: (code, lang) => typeof hljs !== 'undefined' ? hljs.highlightAuto(code).value : code, breaks: true });
            }

            const chatWindow = document.getElementById("chat-window");
            const userInput = document.getElementById("userInput");
            const sendBtn = document.getElementById("sendBtn");
            const voiceBtn = document.getElementById("voiceBtn");
            const historyList = document.getElementById("historyList");
            const overlay = document.getElementById("overlay");
            const previewContainer = document.getElementById("preview-container");
            const imagePreview = document.getElementById("image-preview");

            let chatHistory = JSON.parse(localStorage.getItem("chats") || "[]");
            let currentId = localStorage.getItem("currentChatId") ? parseInt(localStorage.getItem("currentChatId")) : null;
            let attachedFile = null; // { type: 'image'|'pdf', data: base64|text, name: string }

            window.speakText = (text, btn) => {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-SA';
                btn.innerHTML = 'â¸ï¸ ØªÙˆÙ‚Ù';
                utterance.onend = () => btn.innerHTML = 'ğŸ”ˆ ØµÙˆØª';
                window.speechSynthesis.speak(utterance);
            };

            window.copyText = async (text, btn) => {
                await navigator.clipboard.writeText(text);
                btn.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®';
                setTimeout(() => btn.innerHTML = 'ğŸ“‹ Ù†Ø³Ø®', 2000);
            };

            window.clearPreview = () => {
                attachedFile = null;
                previewContainer.style.display = 'none';
                imagePreview.src = "";
                document.getElementById('fileInput').value = "";
            };

            window.handleFileUpload = async (input) => {
                const file = input.files[0];
                if (!file) return;

                try {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            attachedFile = { type: 'image', data: e.target.result.split(',')[1], mimeType: file.type, name: file.name };
                            imagePreview.src = e.target.result;
                            previewContainer.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                        const arrayBuffer = await file.arrayBuffer();
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                        let text = "";
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            text += content.items.map(item => item.str).join(" ") + " ";
                        }
                        attachedFile = { type: 'pdf', data: text, name: file.name };
                        alert("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù PDF Ø¨Ù†Ø¬Ø§Ø­.");
                    }
                } catch (e) { alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù."); }
            };

            window.sendMessage = async () => {
                const text = userInput.value.trim();
                if (!text && !attachedFile) return;
                if (!currentId) newChat();

                const chat = chatHistory.find(c => c.id === currentId);
                chat.messages.push({ role: "user", content: text, file: attachedFile });
                
                const userMsgDiv = document.createElement("div");
                userMsgDiv.className = "message-user";
                if (attachedFile && attachedFile.type === 'image') {
                    userMsgDiv.innerHTML = `<img src="data:${attachedFile.mimeType};base64,${attachedFile.data}" class="max-w-full rounded-lg mb-2"><p>${text}</p>`;
                } else {
                    userMsgDiv.textContent = text;
                }
                chatWindow.appendChild(userMsgDiv);
                
                const currentAttached = attachedFile;
                userInput.value = "";
                userInput.style.height = 'auto';
                clearPreview();
                sendBtn.disabled = true;
                chatWindow.scrollTop = chatWindow.scrollHeight;

                const loading = addMessageUI("ai", '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>');

                try {
                    const payload = {
                        model: "llama-3.2-11b-vision-preview",
                        messages: chat.messages.map(m => {
                            if (m.role === 'user' && m.file && m.file.type === 'image') {
                                return {
                                    role: "user",
                                    content: [
                                        { type: "text", text: m.content || "Ø­Ù„Ù„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø©" },
                                        { type: "image_url", image_url: { url: `data:${m.file.mimeType};base64,${m.file.data}` } }
                                    ]
                                };
                            }
                            return { role: m.role === 'ai' ? 'assistant' : 'user', content: m.role === 'user' && m.file && m.file.type === 'pdf' ? `[Ø³ÙŠØ§Ù‚ PDF: ${m.file.data}]\n\n${m.content}` : m.content };
                        })
                    };

                    const res = await fetch("/.netlify/functions/chat", { 
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    const data = await res.json();
                    loading.remove();
                    if (data.choices && data.choices[0]) {
                        const reply = data.choices[0].message.content;
                        chat.messages.push({ role: "ai", content: reply });
                        addMessageUI("ai", reply);
                        saveChats();
                    } else { throw new Error(); }
                } catch (e) { loading.innerHTML = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±."; } finally { sendBtn.disabled = false; }
            };

            const addMessageUI = (role, text) => {
                const div = document.createElement("div");
                div.className = role === "user" ? "message-user" : "message-ai";
                if (role === "ai") {
                    const cleanText = text.replace(/<\/?[^>]+(>|$)/g, ""); 
                    div.innerHTML = `<div class="msg-content">${marked.parse(text)}</div><div class="msg-controls"><button class="msg-btn" onclick="speakText(\`${cleanText.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, this)">ğŸ”ˆ ØµÙˆØª</button><button class="msg-btn" onclick="copyText(\`${text.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, this)">ğŸ“‹ Ù†Ø³Ø®</button></div>`;
                } else { div.textContent = text; }
                chatWindow.appendChild(div);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return div;
            };

            window.newChat = () => {
                const id = Date.now();
                chatHistory.unshift({ id, title: "Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©", messages: [] });
                currentId = id;
                saveChats(); renderHistory(); renderChat();
            };

            const renderHistory = () => {
                historyList.innerHTML = chatHistory.length ? "" : '<div class="text-center opacity-40">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>';
                chatHistory.forEach(c => {
                    const d = document.createElement("div");
                    d.className = `p-3 rounded-lg cursor-pointer transition-all flex justify-between items-center group ${c.id === currentId ? "bg-purple-600/20 text-white border border-purple-500/30" : "hover:bg-gray-800 text-gray-400"}`;
                    d.innerHTML = `<span class="truncate flex-1">${c.title || "Ù…Ø­Ø§Ø¯Ø«Ø©"}</span><button class="opacity-0 group-hover:opacity-100 text-red-500 px-2" onclick="deleteChat(event, ${c.id})">Ã—</button>`;
                    d.onclick = () => { currentId = c.id; saveChats(); renderHistory(); renderChat(); };
                    historyList.appendChild(d);
                });
            };

            const renderChat = () => {
                chatWindow.innerHTML = "";
                const chat = chatHistory.find(c => c.id === currentId);
                if (!chat || !chat.messages.length) {
                    chatWindow.innerHTML = `<div class="m-auto text-center opacity-40"><div class="text-6xl mb-4">ğŸš€</div><h2 class="text-2xl font-bold">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ ÙƒÙŠÙ Ø£Ø³Ø§Ø¹Ø¯ÙƒØŸ</h2></div>`;
                    return;
                }
                chat.messages.forEach(m => {
                    const div = document.createElement("div");
                    div.className = m.role === "user" ? "message-user" : "message-ai";
                    if (m.role === "user" && m.file && m.file.type === 'image') {
                        div.innerHTML = `<img src="data:${m.file.mimeType};base64,${m.file.data}" class="max-w-full rounded-lg mb-2"><p>${m.content}</p>`;
                    } else if (m.role === "ai") {
                        const cleanText = m.content.replace(/<\/?[^>]+(>|$)/g, ""); 
                        div.innerHTML = `<div class="msg-content">${marked.parse(m.content)}</div><div class="msg-controls"><button class="msg-btn" onclick="speakText(\`${cleanText.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, this)">ğŸ”ˆ ØµÙˆØª</button><button class="msg-btn" onclick="copyText(\`${m.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, this)">ğŸ“‹ Ù†Ø³Ø®</button></div>`;
                    } else { div.textContent = m.content; }
                    chatWindow.appendChild(div);
                });
                chatWindow.scrollTop = chatWindow.scrollHeight;
            };

            const saveChats = () => { localStorage.setItem("chats", JSON.stringify(chatHistory)); localStorage.setItem("currentChatId", currentId); };
            window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('open'); overlay.classList.toggle('active'); };
            userInput.onkeydown = (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
            renderHistory(); renderChat();
        });
    </script>
</body>
</html>
